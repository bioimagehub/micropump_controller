# 3D Stage/Robot Configuration
# Configuration for GRBL-based CNC pipetting robot

# Serial port settings
serial:
  # port: auto-detected based on GRBL response
  baudrate: 115200
  timeout: 2.0

# Well plate definitions
well_plate:
  # Standard 96-well plate (8 rows x 12 columns)
  type: "96-well"
  rows: 8
  columns: 12
  well_spacing: 9.0  # mm between well centers
  
  # Calibration points (measured manually)
  # Top-left corner (A1 position)
  top_left:
    x: 10.0    # X coordinate of well A1
    y: 10.0    # Y coordinate of well A1
  
  # Bottom-right corner (H12 position) for alignment correction
  bottom_right:
    x: 109.0   # X coordinate of well H12 (10 + 11*9.0)
    y: 73.0    # Y coordinate of well H12 (10 + 7*9.0)
  
  # Z-axis positions
  z_base: -5.0        # Safe Z height above plate
  z_approach: -10.0   # Approach height for pipetting
  z_touch: -15.0      # Touch bottom of well
  
  # Well volume and pipetting parameters
  well_volume: 200    # μL max volume per well
  dead_volume: 10     # μL dead volume at bottom

# Named positions for common locations
positions:
  home:
    x: 0.0
    y: 0.0
    z: 0.0
    description: "Home position (origin)"
  
  safe_position:
    x: 50.0
    y: 50.0
    z: 10.0
    description: "Safe position for tool changes"
  
  tip_pickup:
    x: 150.0
    y: 20.0
    z: -2.0
    description: "Pipette tip pickup location"
  
  tip_eject:
    x: 160.0
    y: 20.0
    z: -2.0
    description: "Pipette tip eject location"
  
  waste:
    x: 200.0
    y: 100.0
    z: -10.0
    description: "Waste container position"

# Movement settings
movement:
  # Feed rates (mm/min)
  rapid_rate: 3000      # Fast movement rate
  work_rate: 1000       # Normal work rate
  plunge_rate: 500      # Slow rate for Z-axis plunging
  
  # Acceleration settings
  acceleration: 500     # mm/s²
  
  # Safety limits
  max_travel:
    x: 250.0  # mm
    y: 150.0  # mm
    z: 50.0   # mm

# GRBL settings
grbl:
  # Machine settings to verify/set
  expected_settings:
    "$100": "80.000"    # X steps/mm
    "$101": "80.000"    # Y steps/mm
    "$102": "400.000"   # Z steps/mm
    "$110": "3000.000"  # X max rate, mm/min
    "$111": "3000.000"  # Y max rate, mm/min
    "$112": "500.000"   # Z max rate, mm/min
    "$120": "500.000"   # X acceleration, mm/sec^2
    "$121": "500.000"   # Y acceleration, mm/sec^2
    "$122": "50.000"    # Z acceleration, mm/sec^2
  
  # Startup commands
  startup_commands:
    - "G21"  # Set units to mm
    - "G90"  # Absolute positioning
    - "G94"  # Feed rate per minute
    - "M3 S0"  # Spindle off (if applicable)

# Pipetting protocol defaults
pipetting:
  # Default volumes
  default_volume: 10.0  # μL
  min_volume: 0.5       # μL
  max_volume: 200.0     # μL
  
  # Timing parameters
  aspirate_delay: 0.5   # seconds
  dispense_delay: 0.5   # seconds
  mix_cycles: 3         # number of mix cycles
  
  # Air gaps
  air_gap_volume: 2.0   # μL air gap after aspiration

# Maintenance and calibration
calibration:
  last_calibrated: "2025-09-22"
  calibration_interval_days: 30
  
  # Calibration reference points
  reference_points:
    - name: "A1"
      expected: {x: 10.0, y: 10.0, z: -15.0}
      measured: {x: 10.0, y: 10.0, z: -15.0}
    - name: "H12"
      expected: {x: 109.0, y: 73.0, z: -15.0}
      measured: {x: 109.0, y: 73.0, z: -15.0}

# Logging and debugging
logging:
  level: "INFO"
  log_commands: true
  log_responses: true
  command_timeout: 5.0  # seconds

# Safety features
safety:
  # Soft limits (should match GRBL settings)
  soft_limits_enabled: true
  
  # Emergency stop behavior
  emergency_stop:
    retract_z: 10.0  # mm to retract Z-axis
    move_to_safe: true
  
  # Collision detection
  collision_detection:
    enabled: false
    force_threshold: 100  # Newtons (if force sensor available)

# Multi-plate configurations
plates:
  # Primary plate (default)
  plate1:
    enabled: true
    offset: {x: 0.0, y: 0.0, z: 0.0}
    description: "Primary 96-well plate"
  
  # Secondary plate (if multi-plate setup)
  plate2:
    enabled: false
    offset: {x: 130.0, y: 0.0, z: 0.0}
    description: "Secondary 96-well plate"

# Protocol templates
protocols:
  serial_dilution:
    description: "Standard serial dilution protocol"
    steps:
      - aspirate: {volume: 100, from: "A1"}
      - dispense: {volume: 50, to: "A2"}
      - mix: {cycles: 3, volume: 50, location: "A2"}
  
  plate_fill:
    description: "Fill entire plate with reagent"
    volume: 100
    source: "waste"  # or specific well
    
  cherry_pick:
    description: "Cherry pick specific wells"
    source_wells: ["A1", "B3", "C5"]
    dest_wells: ["H10", "H11", "H12"]
    volume: 50